{% load static %}
<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solvey - Dashboard</title>

  <!-- Bootstrap CSS -->
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link rel="icon" href="{% static 'img/solvey logo.png' %}" type="image/png">
    <link rel="shortcut icon" href="{% static 'img/solvey logo.png' %}" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* Chat Panel - Dark Mode Modern Style */
:root { --panel-width: 360px; }

.chat-panel {
    position: fixed;
    top: 0;
    right: -100%;
    width: var(--panel-width);
    height: 100vh;
    background: #050d1aff;;
    color: #e0e0e0;
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 15px rgba(0,0,0,0.6);
    transition: right 0.3s ease;
    z-index: 1050;
    border-left: 1px solid #333;
}

.chat-panel.open { right: 0; }

.chat-header {
    padding: 15px;
    background: #252525;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header strong { font-size: 1rem; }
.chat-header .text-muted { color: #888; font-size: .8rem; }

.chat-body {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #121212;
}

.msg {
    display: inline-block;
    padding: 10px 14px;
    border-radius: 12px;
    margin-bottom: 8px;
    max-width: 80%;
    line-height: 1.4;
}

.msg.me { background: #006eff; color: #fff; border-bottom-right-radius: 2px; align-self: flex-end; }
.msg.other { background: #222; color: #ddd; border-bottom-left-radius: 2px; }

.chat-footer {
    padding: 12px;
    background: #252525;
    border-top: 1px solid #333;
    display: flex;
    gap: 10px;
}

#msgInput {
    flex: 1;
    background: #1b1b1b;
    border: 1px solid #333;
    color: #fff;
    padding: 10px;
    border-radius: 6px;
}
#msgInput:focus { outline: none; border-color: #006eff; }

#sendBtn {
    background: #006eff;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
}
#sendBtn:hover { background: #006eff; }

#overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0,0,0,0.55);
    z-index: 1040;
    backdrop-filter: blur(2px);
}
#overlay.visible { display: block; }
</style>




</head>
<body>
<div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <div class="logo-text">
                     <h4 class="text-center py-4 fw-bold"><img src="{% static 'img/solvey logo.png' %}"style="widht:100%; height:50px"></h4>
                </div>
            </div>
        </div>

<div class="sidebar-nav">

    <a href="{% url 'index' %}" class="nav-item {% if request.resolver_match.url_name == 'index' %}active{% endif %}">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
        </svg>
        <span>Dashboard</span>
    </a>

    <a href="{% url 'doctors' %}" class="nav-item {% if request.resolver_match.url_name == 'doctors' %}active{% endif %}">
        <i class="fa-solid fa-user-doctor"></i>
        <span>Həkimlər</span>
    </a>

    <a href="{% url 'add-pay-dr' %}" class="nav-item {% if request.resolver_match.url_name == 'add-pay-dr' %}active{% endif %}">
        <i class="fa-solid fa-credit-card"></i>
        <span>Ödəniş Əlavə et</span>
    </a>

    <a href="{% url 'add-doctor' %}" class="nav-item {% if request.resolver_match.url_name == 'add-doctor' %}active{% endif %}">
        <i class="bi bi-person-plus-fill"></i>
        <span>Həkim əlavə et</span>
    </a>

    <a href="{% url 'datasiya' %}" class="nav-item {% if request.resolver_match.url_name == 'datasiya' %}active{% endif %}">
        <i class="bi bi-clipboard-data"></i>
        <span>Datasiya</span>
    </a>

    <a href="{% url 'razilasma' %}" class="nav-item {% if request.resolver_match.url_name == 'razilasma' %}active{% endif %}">
        <i class="fa-solid fa-handshake"></i>
        <span>Razılaşma</span>
    </a>

    <a href="{% url 'finance_view' %}" class="nav-item {% if request.resolver_match.url_name == 'finance_view' %}active{% endif %}">
        <i class="bi bi-cash-coin"></i>
        <span>Maliyyələr</span>
    </a>

    <div class="prescription-divider"></div>

    <a href="{% url 'drugs' %}" class="nav-item {% if request.resolver_match.url_name == 'drugs' %}active{% endif %}">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/>
        </svg>
        <span>Dərmanlar</span>
    </a>

    <a href="{% url 'data_list' %}" class="nav-item {% if request.resolver_match.url_name == 'data_list' %}active{% endif %}">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </svg>
        <span>Aylıq Qeydiyyat</span>
    </a>

    <a href="{% url 'create_recipe' %}" class="nav-item {% if request.resolver_match.url_name == 'create_recipe' %}active{% endif %}">
        <i class="fa-solid fa-plus"></i>
        <span>Qeydiyyat Əlavə et</span>
    </a>

    <div class="prescription-divider"></div>

    <a href="{% url 'sales' %}" class="nav-item {% if request.resolver_match.url_name == 'sales' %}active{% endif %}">
        <i class='bx bx-wallet-alt  icon'></i>
        <span>Aylıq Satışlar</span>
    </a>

    <a href="{% url 'report' %}" class="nav-item {% if request.resolver_match.url_name == 'report' %}active{% endif %}">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
        </svg>
        <span>Aylıq Hesabat</span>
    </a>

    <a href="{% url 'closed_accounts' %}" class="nav-item {% if request.resolver_match.url_name == 'closed_accounts' %}active{% endif %}">
        <i class="bi bi-archive"></i>
        <span>Köhnə Hesabat</span>
    </a>

    <a href="{% url 'create_real_sales' %}" class="nav-item {% if request.resolver_match.url_name == 'create_real_sales' %}active{% endif %}">
        <i class="bi bi-cart-plus-fill"></i>
        <span>Real Satış Əlavə et</span>
    </a>

    <div class="prescription-divider"></div>

    <a href="{% url 'region_list' %}" class="nav-item {% if request.resolver_match.url_name == 'region_list' %}active{% endif %}">
        <i class="bi bi-geo-alt"></i>
        <span>Bölgələr</span>
    </a>

    <a href="{% url 'hospital_list' %}" class="nav-item {% if request.resolver_match.url_name == 'hospital_list' %}active{% endif %}">
        <i class="bi bi-hospital"></i>
        <span>Klinikalar</span>
    </a>

    {% if request.user.is_superuser %}
    <a href="{% url 'admin' %}" class="nav-item {% if request.resolver_match.url_name == 'admin' %}active{% endif %}">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </svg>
        <span>Ayarlar</span>
    </a>
    {% endif %}

</div>



        <div class="sidebar-footer">
            <a href="{% url 'user_logout' %}" class="logout-btn">
                <i class='bx bx-log-out'></i>
                <span>Çıxış</span>
            </a>
        </div>
    </div>
{% comment %}

  <!-- İzləmə -->
  <a class="nav-link" href="{% url 'movqe-gonder' %}">
    <i class="bi bi-geo-fill"></i> İzləmə
  </a>
</div> {% endcomment %}

 {% if request.user.is_superuser %}
<div class="content">
  <div class="top-bar">
        <a href="{% url 'test' %}"style="background-color: rgba(0, 132, 255, 1)">
  <i class="bx bx-file-blank"></i> Komissiya Hesabatı
</a>
{% endif %}


<a href="{% url 'create_recipe' %}"style="background-color: rgba(0, 132, 255, 1)">
  <i class="bx bx-plus-circle"></i> Qeydiyyat Əlavə et
</a>

<a href="{% url 'add-sell' %}"style="background-color: rgba(0, 132, 255, 1)">
  <i class="bx bx-cart-alt"></i> Dərman Satışı Əlavə et
</a>

<a href="{% url 'add-pay-dr' %}"style="background-color: rgba(0, 132, 255, 1)">
  <i class="bx bx-dollar-circle"></i> Həkimə Ödəniş Əlavə et
</a>

        


                    <!-- User Profile -->
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                         <div id="avatarBtn"style="background-color: green;" class="user-avatar" aria-controls="sohbetPanel" aria-expanded="false" title="Sohbet">
                            <i class="bi bi-chat" style="font-size:1.2rem; color: white; "></i>
                            </div>
                        {% if user.is_authenticated %}
                        <span class="user-name">{{ user.username }}</span>
                        {% else %}
                         <a href="{% url 'login' %}" class="text-dark"><img src="{% static 'img/man.png' %}" class="fs-5"></a>
                    {% endif %}
                   
                    </div>

 
 
  </div>



  <div id="overlay" class="chat-overlay" tabindex="-1"></div>


<!-- Sohbet paneli -->
<aside id="sohbetPanel" class="chat-panel" role="dialog" aria-label="Sohbet Paneli">
<div class="chat-header">
<div>
<strong>Canlı bağlantı</strong>
<div class="text-muted" style="font-size:.8rem">Çevrimiçi destek</div>
</div>
<button id="closeBtn" class="btn btn-sm btn-light" aria-label="Kapat">
<i class="bi bi-x"></i>
</button>
</div>


<div class="chat-body" id="chatBody">
<!-- Örnek mesajlar -->
<div class="mb-2">
<div class="msg other">Merhaba! Size nasıl yardımcı olabilirim?</div>
</div>
</div>


<div class="chat-footer">
<input id="msgInput" type="text" class="form-control form-control-sm" placeholder="Mesaj yazın..." aria-label="Mesaj" />
<button id="sendBtn" class="btn btn-sm btn-primary">Gönder</button>
</div>
</aside>
 {% if messages %}
  <div class="alert-container">
    {% for message in messages %}
      <div class="custom-alert 
        {% if message.tags == 'success' %}success
        {% elif message.tags == 'error' %}error
        {% elif message.tags == 'warning' %}warning
        {% elif message.tags == 'info' %}info
        {% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

{% block content %}


{% endblock content %}


<!-- Əvvəlcə jQuery -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

<!-- Sonra Moment.js -->
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

<!-- Daha sonra Daterangepicker -->
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<!-- Sonra Bootstrap (jQuery-dən sonra gəlməlidir) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/main.js' %}"></script>
<script>
// Türkçe değişken isimleri (tercihinize göre)
const avatarBtn = document.getElementById('avatarBtn');
const sohbetPanel = document.getElementById('sohbetPanel');
const overlay = document.getElementById('overlay');
const closeBtn = document.getElementById('closeBtn');
const sendBtn = document.getElementById('sendBtn');
const msgInput = document.getElementById('msgInput');
const chatBody = document.getElementById('chatBody');


function acKapat(toggle) {
    const ac = typeof toggle === 'boolean' ? toggle : !sohbetPanel.classList.contains('open');
    sohbetPanel.classList.toggle('open', ac);
    overlay.classList.toggle('visible', ac);
    avatarBtn.setAttribute('aria-expanded', String(ac));

    if(ac){
        // panel açıldığında inputa odak
        setTimeout(()=> msgInput.focus(), 200);
    }
}


// Tetikleyiciler
avatarBtn.addEventListener('click', ()=> acKapat());
closeBtn.addEventListener('click', ()=> acKapat(false));
overlay.addEventListener('click', ()=> acKapat(false));


// Enter ile gönder
msgInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') sendMesaj();
});
sendBtn.addEventListener('click', sendMesaj);


async function sendMesaj() {
    const text = msgInput.value.trim();
    if (!text) return;

    // İstifadəçi mesajını əlavə et
    const satir = document.createElement('div');
    satir.className = 'mb-2 text-end';
    const balon = document.createElement('div');
    balon.className = 'msg me';
    balon.textContent = text;
    satir.appendChild(balon);
    chatBody.appendChild(satir);
    chatBody.scrollTop = chatBody.scrollHeight;
    msgInput.value = '';
    msgInput.focus();

    try {
        const res = await fetch('http://64.226.72.85:5678/webhook/chat-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
        });
        const data = await res.json();

        // Server cavabını əlavə et
        const botSatir = document.createElement('div');
        botSatir.className = 'mb-2 text-start';
        const botBalon = document.createElement('div');
        botBalon.className = 'msg other';
        botBalon.textContent = data.reply;
        botSatir.appendChild(botBalon);
        chatBody.appendChild(botSatir);
        chatBody.scrollTop = chatBody.scrollHeight;

    } catch (err) {
        console.error('Mesaj göndərmə xətası:', err);
    }
}


// ESC ile kapatma
document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
        acKapat(false);
    }
});

</script>

</body>
</html>


