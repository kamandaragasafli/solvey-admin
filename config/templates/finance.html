{% extends "base.html" %}
{% block content %}
<style>
  body {
    background-color: #030b1a;
    color: #f9fafb;
    font-family: "Inter", sans-serif;
  }

  .card {
    background-color: #273549;
    border: none;
    border-radius: 14px;
    color: #f9fafb;
  }

  .card .breadcrumb {
    background: transparent;
    margin-bottom: 0;
  }

  .breadcrumb-item a {
    color: #60a5fa;
    text-decoration: none;
  }

  .breadcrumb-item a:hover {
    text-decoration: underline;
  }

  .form-label {
    font-weight: 500;
    color: #e5e7eb;
  }

  .form-select,
  .form-control {
    background-color: #374151;
    border: 1px solid #4b5563;
    color: #f9fafb;
    border-radius: 10px;
    transition: all 0.3s ease;
  }

  .form-select:focus,
  .form-control:focus {
    background-color: #4b5563;
    border-color: #60a5fa;
    box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
    color: #fff;
  }

  .btn-primary {
    background-color: #3b82f6;
    border: none;
    border-radius: 10px;
    padding: 10px 18px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-primary:hover {
    background-color: #2563eb;
    transform: scale(1.03);
  }

  h4 {
    font-weight: 600;
    color: #f3f4f6;
  }

  .form-text {
    color: #9ca3af;
  }

  .card.shadow {
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
  }

  select option {
    background-color: #1f2937;
    color: #f9fafb;
  }

  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
  }


  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
  }
</style>
<div class="card shadow-sm" style="width:80%; margin: auto;">
  <div class="card-body">
    <h5 class="card-title mb-4">Verilən Maliyyə</h5>

    <!-- Filter bölməsi -->
    <div class="row mb-3">
      <div class="col-md-4 mb-2">
        <label for="region" class="form-label small ">Bölgə seçin</label>
        <select id="region-select" name="region" class="form-select">
          <option disabled selected>Bölgə Seçin</option>
          {% for r in regions %}
            <option value="{{ r.id }}" {% if r.id|stringformat:"s" == selected_region %}selected{% endif %}>
              {{ r.region_name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 mb-2">
        <label for="doctor-search" class="form-label small">Həkim axtar</label>
        <input type="text" id="doctor-search" class="form-control" placeholder="Həkim adını daxil edin...">
      </div>
      <div class="col-md-2 mb-2 d-flex align-items-end">
      <a href="{% url 'add-pay-dr' %}" class="btn btn-primary w-100">
    <i class="bx bx-dollar-circle"></i> Ödəniş Əlavə et
  </a>

      </div>
      <div class="col-md-2 mb-2 d-flex align-items-end">
      <a href="{% url 'document_add' %}" class="btn btn-primary w-100">
    <i class="bx bx-document"></i> Sənəd Əlavə et
      </a>
      </div>
            <div class="col-md-2 mb-2 d-flex align-items-end">
      <a href="{% url 'financial_documents' %}" class="btn btn-primary w-100">
    <i class="fa-solid fa-folder-open"></i>  Maliyyə Sənədləri
      </a>
      </div>
    </div>
        <div class="col-md-2 mb-2 d-flex align-items-end">
        <a href="javascript:void(0);" onclick="exportExcel()" class="btn btn-success">
      Excel çıxar
    </a>
    </div>


    
     <!-- Statistik məlumatlar -->
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card text-white bg-primary">
          <div class="card-body p-3">
            <h6 class="card-title">Ümumi Həkim</h6>
            <h4 id="total-doctors" class="mb-0">0</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-danger">
          <div class="card-body p-3">
            <h6 class="card-title">Ümumi Avans</h6>
            <h4 id="total-avans" class="mb-0">0.00</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-success">
          <div class="card-body p-3">
            <h6 class="card-title">Ümumi İnvestisiya</h6>
            <h4 id="total-invest" class="mb-0">0.00</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-info">
          <div class="card-body p-3">
            <h6 class="card-title">Maliyyə Verilən</h6>
            <h4 id="finance-given-count" class="mb-0">0</h4>
          </div>
        </div>
      </div>
    </div>

    <hr>
    <div class="row mb-1" style="font-weight: 600; font-size: 0.9rem;">
      <div class="col-md-3">Həkim *</div>
      <div class="col-md-2 text-center">Borc vəziyyəti</div>
      <div class="col-md-3 text-center">Avans</div>
      <div class="col-md-3 text-center">İnvestisiya</div>
    </div>

    <div class="row mb-3" style="font-weight: 700; font-size: 1rem;">
      <div class="col-md-3"></div>
      <div class="col-md-2 text-center"></div>
      <div id="total-given" class="col-md-3 text-center" style="color: #e9042eff;">0</div>
      <div id="total-received" class="col-md-3 text-center" style="color: #00af0fff;">0</div>
    </div>

    <!-- Həkimlər və inputlar -->
    <div id="doctors-container">
      {% if doctors %}
        {% for d in doctors %}
          <div class="row align-items-center mb-2 p-2 rounded" style="background-color: #ebebebff;">
            <div class="col-md-3">
              <button type="button" class="btn btn w-100 text-start">{{ d.ad }}</button>
            </div>
            <div class="col-md-2 fw-bold text-center" style="color: #e9042eff;">{{ d.previous_debt }}</div>
            <div class="col-md-3 text-center d-flex align-items-center justify-content-center gap-2">
              <span class="text-dark fw-bold">Avans:</span>
             <input type="number" class="form-control" style="max-width: 120px;" 
       value="{% if d.avans > 0 %}{{ d.avans }}{% endif %}" readonly />
            </div>
            <div class="col-md-3 text-center d-flex align-items-center justify-content-center gap-2">
              <span class="text-dark fw-bold">İnvestisiya:</span>
              <input type="number" class="form-control" style="max-width: 120px;" 
       value="{% if d.investisiya > 0 %}{{ d.investisiya }}{% endif %}" readonly />
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

<script>
const ajaxUrl = "{% url 'ajax_doctors_by_region' %}";

document.addEventListener("DOMContentLoaded", function () {
  const regionSelect = document.getElementById("region-select");
  const doctorSearch = document.getElementById("doctor-search");
  const doctorsContainer = document.getElementById("doctors-container");

  // Statistik elementlər
  const totalDoctorsElement = document.getElementById("total-doctors");
  const totalAvansElement = document.getElementById("total-avans");
  const totalInvestElement = document.getElementById("total-invest");
  const financeGivenCountElement = document.getElementById("finance-given-count");
  const totalGivenElement = document.getElementById("total-given");
  const totalReceivedElement = document.getElementById("total-received");

  let allDoctors = []; // Bütün həkimləri saxlayırıq

  function calculateStatistics(doctors) {
    let totalAvans = 0;
    let totalInvestisiya = 0;
    let financeGivenCount = 0;

    doctors.forEach(doctor => {
      const avans = parseFloat(doctor.avans) || 0;
      const investisiya = parseFloat(doctor.investisiya) || 0;

      totalAvans += avans;
      totalInvestisiya += investisiya;

      if (avans > 0 || investisiya > 0) {
        financeGivenCount++;
      }
    });

    totalDoctorsElement.textContent = doctors.length;
    totalAvansElement.textContent = totalAvans.toFixed(2);
    totalInvestElement.textContent = totalInvestisiya.toFixed(2);
    financeGivenCountElement.textContent = financeGivenCount;

    totalGivenElement.textContent = totalAvans.toFixed(2);
    totalReceivedElement.textContent = totalInvestisiya.toFixed(2);
  }

  function renderDoctors(doctors) {
    if (doctors.length === 0) {
      doctorsContainer.innerHTML = '<div class="text-center text-muted">Həkim tapılmadı</div>';
      calculateStatistics([]);
      return;
    }

    let html = '';
    doctors.forEach(doctor => {
      const debtColor = doctor.previous_debt < 0 ? '#00af0fff' : '#e9042eff';
      const avansValue = doctor.avans > 0 ? doctor.avans.toFixed(2) : '';
      const investValue = doctor.investisiya > 0 ? doctor.investisiya.toFixed(2) : '';

      html += `
        <div class="row align-items-center mb-2 p-2 rounded" style="background-color: #1f2937;">
          <div class="col-md-3">
            <button type="button" class="btn btn w-100 text-start" style="color: #ebebebff;">${doctor.ad}</button>
          </div>
          <div class="col-md-2 fw-bold text-center" style="color: ${debtColor};">
            ${doctor.previous_debt.toFixed(2)}
          </div>
          <div class="col-md-3 text-center d-flex align-items-center justify-content-center gap-2">
            <span class="fw-bold" style="color: #ebebebff;">Avans:</span>
            <input type="number" class="form-control avans-input" style="max-width: 120px;" value="${avansValue}" readonly />
          </div>
          <div class="col-md-3 text-center d-flex align-items-center justify-content-center gap-2">
            <span class="fw-bold" style="color: #ebebebff;">İnvestisiya:</span>
            <input type="number" class="form-control investisiya-input" style="max-width: 120px;" value="${investValue}" readonly />
          </div>
        </div>
      `;
    });

    doctorsContainer.innerHTML = html;
    calculateStatistics(doctors);
  }

  function filterDoctors() {
    const regionId = regionSelect.value;
    const searchTerm = doctorSearch.value.toLowerCase().trim();

    if (!regionId) {
      alert('Zəhmət olmasa bölgə seçin!');
      return;
    }

    doctorsContainer.innerHTML = 'Yüklənir...';

    fetch(`${ajaxUrl}?region_id=${regionId}`)
      .then(response => response.json())
      .then(data => {
        allDoctors = data.doctors || [];

        let filteredDoctors = allDoctors;
        if (searchTerm) {
          filteredDoctors = allDoctors.filter(d => d.ad.toLowerCase().includes(searchTerm));
        }

        renderDoctors(filteredDoctors);
      })
      .catch(error => {
        console.error('Error:', error);
        doctorsContainer.innerHTML = '<div class="text-center text-danger">Xəta baş verdi</div>';
        calculateStatistics([]);
      });
  }

  // Export Excel funksiyasını qlobal səviyyəyə əlavə et
  window.exportExcel = function() {
    if (!regionSelect.value) {
      alert('Zəhmət olmasa bölgə seçin!');
      return;
    }

    const doctorsToExport = allDoctors.filter(d => d.avans > 0 || d.investisiya > 0);

    if (doctorsToExport.length === 0) {
      alert("Maliyyəsi olan həkim yoxdur!");
      return;
    }

    const region = regionSelect.value;
    window.location.href = `{% url 'finance_export_excel' %}?region=${region}`;
  };

  // Event listeners
  regionSelect.addEventListener("change", filterDoctors);
  doctorSearch.addEventListener("input", function() {
    const searchTerm = this.value.toLowerCase().trim();
    const filteredDoctors = allDoctors.filter(d => d.ad.toLowerCase().includes(searchTerm));
    renderDoctors(filteredDoctors);
  });
});
</script>

{% endblock %}