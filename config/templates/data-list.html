{% extends "base.html" %}

{% block content %}
<div class="card shadow-lg p-3 mb-5" style="width: 90%; margin: auto;">
  <div class="card-body">
    <h4 class="card-title mb-4 fw-semibold text-light d-flex align-items-center gap-2">
      <i class="bi bi-calendar2-week text-success"></i> Aylıq Dannılar
    </h4>

    <!-- Filter Bölməsi -->
    <form method="GET" class="row g-3 align-items-end">
      <div class="col-md-2">
        <label for="region-select" class="form-label small text-secondary">Bölgə seçin</label>
        <select id="region-select" name="region" class="form-select bg-dark text-light border-0 rounded-3" required>
          <option value="" disabled selected>Bölgə Seçin</option>
          {% for r in region %}
            <option value="{{ r.id }}" {% if request.GET.region == r.id|stringformat:"i" %}selected{% endif %}>{{ r.region_name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label for="searchInput" class="form-label small text-secondary">Axtar</label>
        <input type="text" id="searchInput" name="search" class="form-control bg-dark text-light border-0 rounded-3" placeholder="Həkim, dərman..." value="{{ request.GET.search }}">
      </div>

      <div class="col-md-2">
        <label for="month-select" class="form-label small text-secondary">Ay Seçin</label>
        <select id="month-select" name="month" class="form-select bg-dark text-light border-0 rounded-3">
          <option value="">Ay seçin</option>
          <option value="1" {% if request.GET.month == "1" %}selected{% endif %}>Yanvar</option>
          <option value="2" {% if request.GET.month == "2" %}selected{% endif %}>Fevral</option>
          <option value="3" {% if request.GET.month == "3" %}selected{% endif %}>Mart</option>
          <option value="4" {% if request.GET.month == "4" %}selected{% endif %}>Aprel</option>
          <option value="5" {% if request.GET.month == "5" %}selected{% endif %}>May</option>
          <option value="6" {% if request.GET.month == "6" %}selected{% endif %}>İyun</option>
          <option value="7" {% if request.GET.month == "7" %}selected{% endif %}>İyul</option>
          <option value="8" {% if request.GET.month == "8" %}selected{% endif %}>Avqust</option>
          <option value="9" {% if request.GET.month == "9" %}selected{% endif %}>Sentyabr</option>
          <option value="10" {% if request.GET.month == "10" %}selected{% endif %}>Oktyabr</option>
          <option value="11" {% if request.GET.month == "11" %}selected{% endif %}>Noyabr</option>
          <option value="12" {% if request.GET.month == "12" %}selected{% endif %}>Dekabr</option>
        </select>
      </div>

      <div class="col-md-2">
        <label for="date-range" class="form-label small text-secondary">Tarix Aralığı</label>
        <input type="text" id="date-range" name="date_range" class="form-control bg-dark text-light border-0 rounded-3" placeholder="Tarix seçin" value="{{ request.GET.date_range }}">
      </div>

      <div class="col-md-2">
        <label for="name-filter-select" class="form-label small text-secondary">Yazılış Filteri</label>
        <select id="name-filter-select" name="name_filter" class="form-select bg-dark text-light border-0 rounded-3">
          <option value="" selected>Hamısı</option>
          <option value="with_dannisi" {% if request.GET.name_filter == "with_dannisi" %}selected{% endif %}>Adında dannısı olmayanlar</option>
          <option value="without_dannisi" {% if request.GET.name_filter == "without_dannisi" %}selected{% endif %}>Adında dannısı olanlar</option>
        </select>
      </div>

      <div class="col-md-2 d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-success w-50">Filtrlə</button>
        <a href="{% url 'data_list' %}" class="btn btn-outline-light w-50">Təmizlə</a>
      </div>
    </form>

    <!-- Əlavə Düymələr -->
    <div class="d-flex justify-content-end align-items-center mt-4 gap-2">
      <a href="" id="excel-btn" class="btn btn-success btn-sm d-flex align-items-center gap-1">
        <i class="fa-solid fa-file-excel"></i> Excel
      </a>
      <a href="#" id="pdf-btn" class="btn btn-danger btn-sm d-flex align-items-center gap-1">
        <i class="bi bi-file-earmark-pdf"></i> PDF
      </a>
    </div>

    <hr class="border-secondary">

    <!-- Cədvəl -->
    <div class="table-responsive">
      <table class="custom-dark-table"  id="result-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Bölgə</th>
            <th>Həkim</th>
            <th>Son Ödəniş</th>
            <th>Kod</th>
            {% for d in drug %}
              <th>{{ d.med_name }}</th>
            {% endfor %}
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="table-body" style="font-size: 0.75rem;">
          <tr>
            <td colspan="25" class="text-secondary fst-italic">Bölgə seçin...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  body {
    background-color: #030b1a;
    color: #f9fafb;
    font-family: "Inter", sans-serif;
  }

  .card {
    background-color: #273549;
    border: none;
    border-radius: 16px;
    color: #f9fafb;
  }

  .form-control, .form-select {
    background-color: #1a2533 !important;
    color: #f1f1f1 !important;
    border: 1px solid #2d3c51;
    transition: 0.2s ease;
  }

  .form-control:focus, .form-select:focus {
    background-color: #1f2a3a !important;
    border-color: #55e0a3 !important;
    box-shadow: 0 0 0 0.25rem rgba(85, 224, 163, 0.25);
  }

  .btn-success {
    background-color: #55e0a3;
    border: none;
  }

  .btn-success:hover {
    background-color: #42c58a;
  }

  .btn-outline-light:hover {
    background-color: #ffffff;
    color: #000000;
  }

    .table-header {
      padding: 2rem;
      background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
      border-bottom: 1px solid #334155;
    }

    .table-header h1 {
      color: #f8fafc;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .table-header p {
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .table-responsive {
      overflow-x: auto;
      padding: 0;
    }

    .custom-dark-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .custom-dark-table thead {
      background: #0f172a;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .custom-dark-table thead th {
      color: #b5bcc7;
      font-size: 0.60rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 1rem;
      text-align: center;
      border-bottom: 2px solid #334155;
      white-space: nowrap;


  /* Yazını üzü yuxarı çevirmək üçün */
    writing-mode: vertical-rl;  /* və ya vertical-lr */
    transform: rotate(180deg); 
    }

    .custom-dark-table tbody {
      font-size: 0.75rem;
    }

    .custom-dark-table tbody tr {
      background: #1e293b;
      transition: all 0.2s ease;
    }

    .custom-dark-table tbody tr:hover {
      background: #334155;
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .custom-dark-table tbody td {
      padding: 1rem;
      color: #e2e8f0;
      text-align: center;
      border-bottom: 1px solid #334155;
      transition: color 0.2s ease;
    }

    .custom-dark-table tbody tr:last-child td {
      border-bottom: none;
    }

    .text-secondary {
      color: #64748b !important;
    }

    .fst-italic {
      font-style: italic;
    }

    .table-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #3b82f6;
      color: white;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .total-cell {
      font-weight: 700;
      color: #10b981;
      font-size: 0.85rem;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .table-header {
        padding: 1.5rem;
      }

      .table-header h1 {
        font-size: 1.25rem;
      }

      .custom-dark-table thead th,
      .custom-dark-table tbody td {
        padding: 0.75rem 0.5rem;
        font-size: 0.7rem;
      }
    }

    ::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }
/* Daterangepicker arxa plan və mətn rəngi */
.daterangepicker {
    background-color: #273549 !important;
    color: #f1f1f1 !important;
    border-radius: 12px;
    border: 1px solid #000000ff;
}

/* Header (ay və il) */
.daterangepicker .drp-calendar .calendar-table th {
    color: #273549 !important;
    font-weight: 600;
}

/* Günlər */
.daterangepicker td.available {
    background-color: #1a2533;
    color: #f1f1f1;
}

/* Seçilən tarix (active/in-range) */
.daterangepicker td.in-range,
.daterangepicker td.active {
    background-color: #006eff !important; /* mavi arxa fon */
    color: #ffffff !important; /* mətn ağ rəngdə */
    border-radius: 6px;
    border: none; /* əgər sərhəd lazım deyilsə */
}


/* Apply və Cancel düymələri */
.daterangepicker .applyBtn {
    background-color: #0b71ffff !important;
    color: #000 !important;
}
.daterangepicker .cancelBtn {
    background-color: #ff1616ff !important;
    color: #fff !important;
}
/* Scrollbar track (arxa plan) */
::-webkit-scrollbar-track {
  background: #15181bff; /* track background */
  border-radius: 10px;
}

/* Scrollbar thumb (sürüşdürülən hissə) */
::-webkit-scrollbar-thumb {
  background-color: #1a2533 !important; /* əsas vurğu rəngi */
  border-radius: 10px;
  border: 2px solid #1a2533; /* track ilə uyğunlaşması üçün sərhəd */
}

/* Hover effekti */
::-webkit-scrollbar-thumb:hover {
  background-color: #1a2533 !important;
}

/* Firefox üçün */
* {
  scrollbar-width: thin;           /* incə scrollbar */
  scrollbar-color: #1a2533 !important; #1a2533; /* thumb / track */
}

</style>


<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

let currentPage = 1;
let totalPages = 1;

function loadRegionData(regionId, page = 1) {
  const dateRangeInput = document.getElementById('date-range');
  const dateRange = dateRangeInput ? dateRangeInput.value : "";

  const nameFilterSelect = document.getElementById('name-filter-select');
  const nameFilter = nameFilterSelect ? nameFilterSelect.value : "";

  const searchInput = document.getElementById('searchInput');
  const searchTerm = searchInput ? searchInput.value.trim() : "";

  const monthSelect = document.getElementById('month-select');
  const month = monthSelect ? monthSelect.value : "";

  const params = new URLSearchParams({ 
    region_id: regionId,
    page: page 
  });

  if (dateRange) params.append('date_range', dateRange);
  if (nameFilter) params.append('name_filter', nameFilter);
  if (searchTerm) params.append('search', searchTerm);
  if (month) params.append('month', month);

  fetch(`/doctors/ajax/region-data/?${params.toString()}`)
    .then(response => {
      if (!response.ok) throw new Error("Server cavabı düzgün deyil");
      return response.json();
    })
    .then(data => {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = "";

      currentPage = data.current_page || 1;
      totalPages = data.total_pages || 1;

      if (!data.results || data.results.length === 0) {
        tbody.innerHTML = `<tr><td colspan="25" class="text-muted fst-italic">Seçilən bölgəyə uyğun məlumat tapılmadı.</td></tr>`;
        updatePagination();
        return;
      }

      const allTh = Array.from(document.querySelectorAll('thead th'));
      const drugNames = allTh.slice(5, allTh.length - 1).map(th => th.textContent.trim());

      data.results.forEach((item, index) => {
        let drugCells = "";
        drugNames.forEach(drugName => {
          const drugObj = item.drugs.find(d => d.name === drugName);
          const count = drugObj ? drugObj.count : 0;
          const cellClass = count > 0 ? 'style="background-color: #0f172a; font-weight: bold;"' : '';
          drugCells += `<td ${cellClass}>${count}</td>`;
        });

        let odemeClass = "text-success"; // default yaşıl
        if (item.odeme.type === "avans") odemeClass = "text-primary";
        else if (item.odeme.type === "investisiya") odemeClass = "text-warning";
        else if (item.odeme.type === "geriqaytarma") odemeClass = "text-danger";

        const odemeCell = `
          <td class="${odemeClass}">
            ${parseFloat(item.odeme.amount).toFixed(2)}
            ${item.odeme.date ? `<small class="d-block text-light">${item.odeme.date}</small>` : ""}
          </td>`;



        const globalIndex = (currentPage - 1) * 10 + index + 1;

        const row = `
          <tr>
            <td>${globalIndex}</td>
            <td>${item.bolge}</td>
            <td>
              <a href="/doctors/details/${item.doctor_id}/" class="text-primary fw-semibold text-decoration-none">
                ${item.doctor}
              </a>
            </td>
            ${odemeCell}
            <td>${item.barcode}</td>
            ${drugCells}
            <td class="fw-bold">${parseFloat(item.total)}</td>
          </tr>`;

        tbody.insertAdjacentHTML('beforeend', row);
      });

      updatePagination();
    })
    .catch(error => {
      console.error("Xəta baş verdi:", error);
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = `<tr><td colspan="25" class="text-danger">Xəta baş verdi.</td></tr>`;
      updatePagination();
    });
}

// Pagination dizaynlı
function updatePagination() {
  let paginationContainer = document.getElementById('pagination-container');
  
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = 'pagination-container';
    paginationContainer.className = 'd-flex justify-content-center align-items-center mt-3';
    document.querySelector('.card-body').appendChild(paginationContainer);
  }

  if (totalPages <= 1) {
    paginationContainer.innerHTML = '';
    return;
  }

  let buttons = "";
  for (let i = 1; i <= totalPages; i++) {
    buttons += `
      <li class="page-item ${currentPage === i ? 'active' : ''}">
        <button class="page-link" onclick="changePage(${i})">${i}</button>
      </li>`;
  }

  paginationContainer.innerHTML = `
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <button class="page-link" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>
        </li>
        ${buttons}
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <button class="page-link" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>
        </li>
      </ul>
    </nav>`;
}

function changePage(page) {
  if (page < 1 || page > totalPages) return;
  const regionSelect = document.getElementById('region-select');
  const regionId = regionSelect.value;
  if (regionId) loadRegionData(regionId, page);
}

// Axtarış bütün region üzrə
document.getElementById('searchInput').addEventListener('input', () => {
  const regionSelect = document.getElementById('region-select');
  const regionId = regionSelect.value;
  if (regionId) loadRegionData(regionId, 1); // hər zaman səhifə 1-dən başlayır
});

// Cari ay, datepicker və digər event-lər əvvəlki kimi qalır
function initializeDateRangePicker() {
  const dateRangeInput = document.getElementById('date-range');
  if (dateRangeInput && typeof $ !== 'undefined' && $.fn.daterangepicker) {
    $(dateRangeInput).daterangepicker({
      locale: {
        format: 'YYYY-MM-DD',
        separator: ' - ',
        applyLabel: 'Təsdiqlə',
        cancelLabel: 'Ləğv et',
        fromLabel: 'Başlanğıc',
        toLabel: 'Son',
        customRangeLabel: 'Xüsusi',
        weekLabel: 'Həftə',
        daysOfWeek: ['Bz', 'Be', 'Ça', 'Ç', 'Ca', 'C', 'Ş'],
        monthNames: ['Yanvar','Fevral','Mart','Aprel','May','İyun','İyul','Avqust','Sentyabr','Oktyabr','Noyabr','Dekabr'],
        firstDay: 1
      },
      startDate: moment().startOf('month'),
      endDate: moment().endOf('month'),
      opens: 'center'
    });

    $(dateRangeInput).on('apply.daterangepicker', function (ev, picker) {
      const regionId = document.getElementById('region-select').value;
      if (regionId) loadRegionData(regionId, 1);
    });
  }
}

function setCurrentMonth() {
  const monthSelect = document.getElementById('month-select');
  if (monthSelect) monthSelect.value = (new Date().getMonth() + 1).toString();
}

document.addEventListener('DOMContentLoaded', () => {
  const regionSelect = document.getElementById('region-select');
  const nameFilterSelect = document.getElementById('name-filter-select');
  const monthSelect = document.getElementById('month-select');
  const form = document.querySelector('form');

  setCurrentMonth();
  initializeDateRangePicker();

  regionSelect.addEventListener('change', () => loadRegionData(regionSelect.value, 1));
  nameFilterSelect.addEventListener('change', () => loadRegionData(regionSelect.value, 1));
  monthSelect.addEventListener('change', () => loadRegionData(regionSelect.value, 1));

  form.addEventListener('submit', e => {
    e.preventDefault();
    if (regionSelect.value) loadRegionData(regionSelect.value, 1);
    else alert("Zəhmət olmasa bölgə seçin");
  });
  document.getElementById('excel-btn').addEventListener('click', function (e) {
  e.preventDefault();

  const regionId = regionSelect.value;
  const nameFilter = nameFilterSelect.value;
  const dateRange = document.getElementById('date-range').value;
  const searchTerm = searchInput.value.trim();
  const month = monthSelect.value;

  if (!regionId) {
    alert("Zəhmət olmasa bölgə seçin");
    return;
  }

  const params = new URLSearchParams({ region_id: regionId });

  if (dateRange) params.append('date_range', dateRange);
  if (nameFilter) params.append('name_filter', nameFilter);
  if (searchTerm) params.append('search', searchTerm);
  if (month) params.append('month', month);


  const url = `/doctors/export-region-excel/?${params.toString()}`;
  window.location.href = url;
});


  
});

</script>
{% endblock content %}